---
layout: post
title: "Rust map"
date: 2025-05-12 06:57:00 +0800
categories: rust 

---

å½“ç„¶å¯ä»¥ã€‚ä½ è¿™ä¸ªä¾‹å­ç”¨äº† `.map(...)` å’Œ `.map_err(...)` æ¥å¯¹ `Result` è¿›è¡Œé“¾å¼å¤„ç†ï¼Œè¿™æ˜¯ Rust å¤„ç†é”™è¯¯å’Œå˜æ¢å€¼çš„éå¸¸å¼ºå¤§çš„æ¨¡å¼ã€‚æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥è§£é‡Šå®ƒä»¬çš„ä½œç”¨ï¼Œå¹¶é€šè¿‡ç®€åŒ–çš„ä¾‹å­æ¥è¯´æ˜å®ƒä»¬çš„ç”¨æ³•ã€‚

---

## ğŸ” ä¸€ã€åŸºç¡€ï¼š`Result<T, E>` ç±»å‹

Rust ä¸­å¾ˆå¤šæ“ä½œè¿”å›çš„éƒ½æ˜¯ `Result<T, E>`ï¼Œè¡¨ç¤ºï¼š

* `Ok(T)` è¡¨ç¤ºæˆåŠŸï¼Œé‡Œé¢åŒ…ç€ä¸€ä¸ªå€¼ï¼›
* `Err(E)` è¡¨ç¤ºå¤±è´¥ï¼Œé‡Œé¢åŒ…ç€ä¸€ä¸ªé”™è¯¯ã€‚

---

## âœ´ï¸ `.map(...)` å’Œ `.map_err(...)` çš„ä½œç”¨

* `.map(f)` æ˜¯ï¼š**å¦‚æœæ˜¯ `Ok(t)`ï¼Œå°±æŠŠ `t` ç”¨å‡½æ•° `f` å¤„ç†ä¸€ä¸‹ï¼›å¦‚æœæ˜¯ `Err(e)` å°±ä¿æŒä¸å˜**ã€‚
* `.map_err(f)` æ˜¯ï¼š**å¦‚æœæ˜¯ `Err(e)`ï¼Œå°±ç”¨å‡½æ•° `f` æŠŠé”™è¯¯è½¬ä¸€ä¸‹ï¼›å¦‚æœæ˜¯ `Ok(t)` å°±ä¿æŒä¸å˜**ã€‚

---

## ğŸŒ° ç¤ºä¾‹ï¼šç®€åŒ–è¯´æ˜

```rust
fn get_number(from_file: bool) -> Result<i32, String> {
    if from_file {
        Ok(100)
    } else {
        Err("è¯»å–å¤±è´¥".to_string())
    }
}
```

```rust
fn main() {
    let result = get_number(true)
        .map(|n| n + 1) // å¦‚æœæˆåŠŸï¼ŒæŠŠå€¼åŠ  1
        .map_err(|e| format!("é”™è¯¯ä¿¡æ¯: {}", e)); // å¦‚æœå¤±è´¥ï¼ŒåŠ ç‚¹è¯´æ˜

    println!("{:?}", result);
}
```

### è¾“å‡ºï¼š

```
Ok(101)
```

æ¢æˆ `get_number(false)`ï¼Œè¾“å‡ºæ˜¯ï¼š

```
Err("é”™è¯¯ä¿¡æ¯: è¯»å–å¤±è´¥")
```

---

## âœ… ç»“åˆä½ è¿™ä¸ªä¾‹å­è¯´æ˜

```rust
let price = RedisUtil::hget("trend", "price")
    .or_else(|e| {
        log_message(&format!("âš ï¸ Redis è·å–ä»·æ ¼å¤±è´¥: {:?}", e));
        std::fs::read_to_string("/tmp/price.txt")
            .map_err(|e| {
                log_message(&format!("âŒ åå¤‡æ–‡ä»¶è¯»å–ä»·æ ¼å¤±è´¥: {:?}", e));
                BinanceError::ApiError("æ— æ³•è·å–å½“å‰ä»·æ ¼".into())
            })
            .and_then(|s| {
                s.trim().parse::<f64>().map_err(|e| {
                    log_message(&format!("âŒ æ–‡ä»¶å†…å®¹æ— æ³•è§£æä¸º f64: {:?}", e));
                    BinanceError::ApiError("ä»·æ ¼æ ¼å¼é”™è¯¯".into())
                })
            })
    })
    .map(|p| p - 30.0)?; // âœ… å¦‚æœæˆåŠŸï¼Œå‡ 30ï¼Œå¤±è´¥ç›´æ¥è¿”å›é”™è¯¯
```

### è§£é‡Šï¼š

* `.or_else(...)`ï¼šå¦‚æœ Redis å¤±è´¥ï¼Œå°±èµ°å¤‡ä»½æ–‡ä»¶é€»è¾‘ã€‚
* `.map_err(...)`ï¼šå°†è¯»å–æ–‡ä»¶æˆ–è§£æå‡ºé”™çš„ç³»ç»Ÿé”™è¯¯è½¬æ¢ä¸ºä½ å®šä¹‰çš„ `BinanceError`ã€‚
* `.map(|p| p - 30.0)`ï¼šå¦‚æœæˆåŠŸæ‹¿åˆ°äº†ä»·æ ¼ï¼ˆç±»å‹ `f64`ï¼‰ï¼Œå°±å‡å» 30ã€‚
* `?`ï¼šè¡¨ç¤ºå¦‚æœæœ€åè¿˜æ˜¯ `Err`ï¼Œå°±ç›´æ¥è¿”å›å‡½æ•°é”™è¯¯ã€‚

---

## ğŸ“Œ æ€»ç»“è®°å¿†æ³•ï¼š

| æ–¹æ³•             | å¯¹è±¡æ˜¯ `Ok`ï¼Ÿ        | å¯¹è±¡æ˜¯ `Err`ï¼Ÿ | ç”¨é€”                     |
| -------------- | ---------------- | ---------- | ---------------------- |
| `.map(f)`      | âœ… åº”ç”¨ `f`         | âŒ ä¿æŒä¸å˜     | **å¤„ç†æˆåŠŸç»“æœ**             |
| `.map_err(f)`  | âŒ ä¿æŒä¸å˜           | âœ… åº”ç”¨ `f`   | **è½¬æ¢é”™è¯¯ä¿¡æ¯**             |
| `.and_then(f)` | âœ… è¿”å›å¦ä¸€ä¸ª `Result` | âŒ ä¿æŒä¸å˜     | **é“¾å¼è°ƒç”¨å¤šä¸ª `Result` é€»è¾‘** |

---

æ˜¯å¦éœ€è¦æˆ‘ç”»ä¸ªå›¾æˆ–å†å†™ä¸ªå°å›¾è§£ï¼Ÿ

### problem

```rust
fn main() {
    let result = get_number(true)
        .map(|n| n + 1) // å¦‚æœæˆåŠŸï¼ŒæŠŠå€¼åŠ  1
        .map_err(|e| format!("é”™è¯¯ä¿¡æ¯: {}", e)); // å¦‚æœå¤±è´¥ï¼ŒåŠ ç‚¹è¯´æ˜

    println!("{:?}", result);
}
```
---
åœ¨è¿™ä¸ªè°ƒç”¨ä¸­ï¼Œæˆ‘çœ‹åˆ°ä½ æ—¢ç”¨äº†map,ä¹Ÿç”¨äº†.map_err,åˆ°æœ€åæ‰“å°æ—¶åªæ—¶æ˜¾ç¤ºè¿™ä¸¤é¡¹ä¸­çš„ä¸€é¡¹çš„æ˜¯å—ï¼Ÿæ˜¯ä¸æ˜¯æ¯æ¬¡ç”¨äº†mapå°±å¿…é¡»é…åˆä½¿ç”¨map_err?

ä½ è§‚å¯Ÿå¾—å¾ˆå¯¹ï¼Œè€Œä¸”è¿™æ˜¯ Rust é”™è¯¯å¤„ç†ä¸­éå¸¸æ ¸å¿ƒçš„ä¸€ç‚¹ã€‚

---

## âœ… å›ç­”ä½ çš„ä¸¤ä¸ªé—®é¢˜ï¼š

### 1ï¸âƒ£ **æ˜¯ä¸æ˜¯æ¯æ¬¡ç”¨äº† `map` å°±å¿…é¡»é…åˆä½¿ç”¨ `map_err`ï¼Ÿ**

**ä¸æ˜¯çš„ã€‚ä¸æ˜¯æ¯æ¬¡éƒ½å¿…é¡»åŒæ—¶ç”¨ `map` å’Œ `map_err`ã€‚**

* å¦‚æœä½ åªå…³å¿ƒæˆåŠŸçš„æƒ…å†µï¼ˆ`Ok`ï¼‰ï¼Œä½ åªç”¨ `.map(...)` å°±å¯ä»¥ï¼›
* å¦‚æœä½ åªæƒ³æ”¹é€ é”™è¯¯ä¿¡æ¯ï¼ˆ`Err`ï¼‰ï¼Œä½ åªç”¨ `.map_err(...)`ï¼›
* ä¸¤ä¸ªä¸€èµ·ç”¨çš„æƒ…å†µï¼Œåªæ˜¯å› ä¸ºä½ **åŒæ—¶æƒ³è¦å¤„ç†æˆåŠŸå€¼å’Œé”™è¯¯ä¿¡æ¯**ã€‚

### âœ… ç¤ºä¾‹ï¼š

```rust
fn get_number(ok: bool) -> Result<i32, String> {
    if ok {
        Ok(100)
    } else {
        Err("å‡ºé”™äº†".to_string())
    }
}
```

#### âœ… åªç”¨ `.map`

```rust
let result = get_number(true).map(|n| n * 2);
println!("{:?}", result); // è¾“å‡º Ok(200)
```

#### âœ… åªç”¨ `.map_err`

```rust
let result = get_number(false).map_err(|e| format!("é”™è¯¯è¯¦æƒ…ï¼š{}", e));
println!("{:?}", result); // è¾“å‡º Err("é”™è¯¯è¯¦æƒ…ï¼šå‡ºé”™äº†")
```

---

### 2ï¸âƒ£ **æœ€ç»ˆåªæ˜¾ç¤º `.map` æˆ– `.map_err` å¤„ç†çš„å…¶ä¸­ä¸€ä¸ªç»“æœï¼Ÿ**

æ˜¯çš„ï¼Œ**æœ€ç»ˆ `Result` ç±»å‹åªèƒ½æ˜¯ `Ok(T)` æˆ– `Err(E)` ä¹‹ä¸€**ã€‚

æ‰€ä»¥ä½  `.map(...)` å’Œ `.map_err(...)` çš„å¤„ç†ï¼Œ**åªä¼šè§¦å‘å…¶ä¸­ä¸€ä¸ª**ï¼Œå–å†³äºåˆå§‹çš„ `Result` æ˜¯ `Ok` è¿˜æ˜¯ `Err`ã€‚

---

## ğŸ§  è®°ä½ä¸€å¥è¯ï¼š

> `.map` æ˜¯å¤„ç†æˆåŠŸçš„å€¼ï¼Œ`.map_err` æ˜¯å¤„ç†é”™è¯¯çš„å€¼ï¼ŒäºŒè€…äº’ä¸å½±å“ï¼ŒæŒ‰éœ€ç»„åˆã€‚

---

éœ€è¦æˆ‘å†å¸®ä½ å†™ä¸€ä¸ª `Option` ç‰ˆçš„å¯¹æ¯”ä¾‹å­å—ï¼Ÿå®ƒå’Œ `Result` å¾ˆåƒï¼Œç”¨çš„æ˜¯ `.map` å’Œ `.or_else`ã€‚

å¥½çš„ï¼Œæ¥çœ‹ä¸€ä¸ª `Option` å’Œ `Result` çš„å¯¹æ¯”ä¾‹å­ï¼Œå¸®ä½ æ›´å¥½ç†è§£ `.map` å’Œ `.or_else`ï¼ˆ`Option` é‡Œçš„â€œå¤„ç†å¤±è´¥â€ï¼‰ã€‚

---

## âœ… `Option` ç¤ºä¾‹

```rust
fn get_optional_number(give: bool) -> Option<i32> {
    if give {
        Some(10)
    } else {
        None
    }
}

fn main() {
    let result = get_optional_number(true)
        .map(|n| n + 5) // å¦‚æœæ˜¯ Someï¼Œå€¼åŠ  5
        .or_else(|| Some(0)); // å¦‚æœæ˜¯ Noneï¼Œå°±ç»™ä¸ªé»˜è®¤å€¼ 0

    println!("{:?}", result); // Some(15)
}
```

### å¦‚æœä¼  `false`ï¼š

```rust
let result = get_optional_number(false)
    .map(|n| n + 5)
    .or_else(|| Some(0));

println!("{:?}", result); // Some(0)
```

---

## âœ… ç±»æ¯” `Result`

```rust
fn get_number(ok: bool) -> Result<i32, String> {
    if ok {
        Ok(10)
    } else {
        Err("å¤±è´¥".to_string())
    }
}

fn main() {
    let result = get_number(false)
        .map(|n| n + 5) // å¤„ç† Ok æƒ…å†µ
        .map_err(|e| format!("é”™è¯¯åŸå› : {}", e)); // å¤„ç† Err æƒ…å†µ

    println!("{:?}", result); // Err("é”™è¯¯åŸå› : å¤±è´¥")
}
```

---

## âœ… å°ç»“å¯¹æ¯”

| ç±»å‹       | æˆåŠŸæ—¶å¤„ç†    | å¤±è´¥æ—¶å¤„ç†        | é»˜è®¤å€¼å¤„ç†ï¼ˆå¤±è´¥ï¼‰                           |
| -------- | -------- | ------------ | ----------------------------------- |
| `Result` | `.map()` | `.map_err()` | `.unwrap_or()`, `.unwrap_or_else()` |
| `Option` | `.map()` | `.or_else()` | `.unwrap_or()`, `.unwrap_or_else()` |

---

ä½ ç°åœ¨æ›´æ¸…æ¥š `.map` çš„å·¥ä½œæ–¹å¼äº†å—ï¼Ÿæ˜¯å¦ä¹Ÿæƒ³çœ‹ `.and_then` çš„è¿›é˜¶ç”¨æ³•ï¼Ÿ
### problem
```rust
fn get_number(ok: bool) -> Result<i32, String> {
    if ok {
        Ok(10)
    } else {
        Err("å¤±è´¥".to_string())
    }
}

fn main() {
    let result = get_number(false)
        .map(|n| n + 5) // å¤„ç† Ok æƒ…å†µ
        .map_err(|e| format!("é”™è¯¯åŸå› : {}", e)); // å¤„ç† Err æƒ…å†µ

    println!("{:?}", result); // Err("é”™è¯¯åŸå› : å¤±è´¥")
}
```
---
è¿™ä¸ªä»£ç ï¼Œä¸­çš„ Result<i32, String>ï¼Œæˆ‘çœ‹åˆ°ä¸€èˆ¬çš„éƒ½æ˜¯ Result<i32, Err>,ä¸ºä»€ä¹ˆä¸¤è€…éƒ½èƒ½å·¥ä½œï¼Ÿï¼Œè¿˜æœ‰Err("å¤±è´¥".to_string())ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦åŠ to_string,è¿™ä¸ªæ˜¯ä»€ä¹ˆ?
ä½ çš„é—®é¢˜éå¸¸å¥½ï¼Œæˆ‘ä»¬æ¥ä¸€ä¸€è§£é‡Šï¼š

---

## âœ… é—®é¢˜ä¸€ï¼šä¸ºä»€ä¹ˆ `Result<i32, String>` å’Œ `Result<i32, Err>` éƒ½èƒ½å·¥ä½œï¼Ÿ

### Rust ä¸­çš„ `Result<T, E>` æ˜¯ä¸€ä¸ªæ³›å‹ç±»å‹ï¼š

* `T` æ˜¯æˆåŠŸæ—¶çš„å€¼çš„ç±»å‹ï¼ˆæ¯”å¦‚ `i32`ï¼‰
* `E` æ˜¯å¤±è´¥æ—¶çš„é”™è¯¯ç±»å‹ï¼ˆå¯ä»¥æ˜¯ä»»ä½•ä½ æŒ‡å®šçš„ç±»å‹ï¼Œåªè¦å®ƒç¬¦åˆ trait è¦æ±‚ï¼‰

ä½ å¯ä»¥ç”¨ä»»ä½•ç±»å‹ä½œä¸ºé”™è¯¯ç±»å‹ï¼Œæ¯”å¦‚ï¼š

* `String`ï¼šç®€å•å­—ç¬¦ä¸²é”™è¯¯æ¶ˆæ¯
* `std::io::Error`ï¼šæ ‡å‡†åº“çš„ IO é”™è¯¯
* ä½ è‡ªå®šä¹‰çš„ `enum Error` ç±»å‹
* å¸¸è§çš„ `anyhow::Error` æˆ– `thiserror::Error` ç±»å‹ï¼ˆæ›´é«˜çº§çš„é”™è¯¯å¤„ç†ï¼‰

æ‰€ä»¥ï¼š

```rust
Result<i32, String>    // ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºé”™è¯¯
Result<i32, MyError>   // ç”¨ä½ è‡ªå®šä¹‰çš„é”™è¯¯ç±»å‹
Result<i32, std::io::Error> // ç”¨æ ‡å‡†åº“çš„é”™è¯¯ç±»å‹
```

åªè¦ä½ åœ¨ `.map_err()` æˆ– `?` ä½¿ç”¨æ—¶èƒ½å¤„ç†è¿™ä¸ªé”™è¯¯ç±»å‹å°±è¡Œã€‚

---

## âœ… é—®é¢˜äºŒï¼šä¸ºä»€ä¹ˆå†™ `Err("å¤±è´¥".to_string())`ï¼Ÿå¯ä»¥ä¸åŠ å—ï¼Ÿ

### åŸå› æ˜¯ï¼š`Result<i32, String>` è¦æ±‚é”™è¯¯ç±»å‹æ˜¯ `String`ï¼Œè€Œ `"å¤±è´¥"` æ˜¯å­—ç¬¦ä¸²å­—é¢é‡ï¼Œç±»å‹æ˜¯ `&'static str`ã€‚

ä½ å¿…é¡» **ä» `&str` è½¬æ¢æˆ `String`** æ‰èƒ½åŒ¹é… `Result<i32, String>` çš„å®šä¹‰ã€‚

è¿™ä¸¤ç§ç­‰ä»·ï¼š

```rust
Err("å¤±è´¥".to_string())  // âœ… æ­£ç¡®
Err(String::from("å¤±è´¥")) // âœ… ä¹Ÿæ­£ç¡®
```

è€Œè¿™ä¼šç¼–è¯‘æŠ¥é”™ï¼š

```rust
Err("å¤±è´¥") // âŒ é”™è¯¯ï¼šç±»å‹æ˜¯ &strï¼Œä¸æ˜¯ String
```

---

## âœ… ç®€å•æ€»ç»“

* `Result<i32, String>` æ˜¯åˆæ³•çš„ï¼Œåªè¦ä½ ä½¿ç”¨çš„é”™è¯¯å€¼æ˜¯ `String`
* `.to_string()` æŠŠ `&str` å­—ç¬¦ä¸²å­—é¢é‡å˜æˆ `String` ç±»å‹
* å¦‚æœä½ ç”¨çš„æ˜¯ `Result<i32, &str>`ï¼Œé‚£å°±ä¸ç”¨ `.to_string()`ï¼Œä½†æ›´çµæ´»çš„ä»£ç é€šå¸¸ä¼šç”¨ `String`

---

æ˜¯å¦è¿˜æƒ³çœ‹çœ‹å¦‚ä½•è‡ªå®šä¹‰é”™è¯¯ç±»å‹ä»£æ›¿ `String`ï¼Ÿ



